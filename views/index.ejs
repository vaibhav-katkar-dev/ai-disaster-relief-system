
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emergency Aid Now</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="/style/bot.css">
    <style>
     body, html {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      color: #333;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 30px;
      background-color: #f8f9fa;
      border-bottom: 1px solid #e0e0e0;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .header .logo {
      font-size: 1.5em;
      font-weight: bold;
      color: #d32f2f;
    }

    .header .nav a,
    .login-btn {
      margin-left: 20px;
      text-decoration: none;
      color: #1a0dab;
      font-weight: 500;
      font-size: 1em;
    }

    .login-btn {
      background-color: #1a0dab;
      color: #fff;
      padding: 8px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .login-btn:hover {
      background-color: #163a7a;
    }

    .content {
      padding: 40px 20px;
      text-align: center;
      max-width: 1200px;
      margin: auto;
    }

    .title {
      color: #d32f2f;
      font-size: 2.5em;
    }

    .description {
      color: #6c757d;
      font-size: 1.1em;
      margin-bottom: 30px;
    }

    .buttons .btn {
      background-color: #1a2a44;
      color: white;
      padding: 12px 25px;
      border: none;
      border-radius: 5px;
      margin: 0 15px;
      font-size: 1em;
      cursor: pointer;
    }

    .buttons .btn:hover {
      background-color: #13263d;
    }

    .map-section {
      margin-top: 40px;
    }

    #disasterMap {
      height: 400px;
      background-color: #f1f1f1;
      border-radius: 8px;
      margin: 20px 0;
    }

    #disasterMap.fullscreen {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh !important;
      width: 100vw !important;
      z-index: 9999;
      border-radius: 0 !important;
      transition: all 0.3s ease;
    }

    body.fullscreen-map {
      overflow: hidden;
    }

    .view-map-btn {
      background-color: #f1f1f1;
      border: 1px solid #ddd;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      color: #1a2a44;
    }

    .legend {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 10px;
    }

    .legend span {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.9em;
    }

    .status-section {
      margin-top: 40px;
      background-color: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
    }

    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
    }

    .status-card {
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .status-card h3 {
      color: #1a2a44;
    }

    .how-it-works {
      margin-top: 40px;
      padding: 40px 20px;
      background-color: #f9f9f9;
      border-radius: 8px;
    }

    .how-it-works h2 {
      color: #1a2a44;
    }

    .how-it-works-items {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
    }

    .how-it-works-item {
      flex: 1;
      min-width: 200px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .how-it-works-item i {
      font-size: 2em;
      margin-bottom: 10px;
    }

    .footer {
      background-color: #1a2a44;
      color: white;
      padding: 40px 20px;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
    }

    .footer-section h3 {
      color: #d32f2f;
    }

    .footer-section a,
    .footer-section p {
      color: #e0e0e0;
      text-decoration: none;
      margin: 8px 0;
    }

    .footer-bottom {
      text-align: center;
      width: 100%;
      margin-top: 20px;
      color: #b0b0b0;
    }
    /* Floating Bot Container */
#floating-bot {
    position: fixed;
    bottom: 20px;
    right: 20px;


    margin-right: 40px;
    z-index: 1000;
}

/* Bot Icon */
#bot-icon {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #4A90E2, #0084FF);
    color: white;
    border-radius: 50%;
    font-size: 30px;
    display: flex;
    align-items: center;
    /* z-index: 1000; */

    justify-content: center;
    cursor: pointer;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
    animation: floaty 3s ease-in-out infinite alternate;
}

/* Hover Effect - Bot Moves Slightly */
#bot-icon:hover {
    transform: scale(1.1) translateY(-5px);
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
}

/* Chat Box */
#bot-chat {
    width: 300px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    overflow: hidden;
    position: absolute;
    bottom: 70px;
    right: 0;
    display: none;
    flex-direction: column;
    font-family: Arial, sans-serif;
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
}

/* Show Chat Animation */
#bot-chat.active {
    display: flex;
    opacity: 1;
    transform: translateY(0);
}

/* Chat Header */
#bot-header {
    background: #4A90E2;
    color: white;
    padding: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 16px;
    font-weight: bold;
}

#close-bot {
    background: none;
    border: none;
    color: white;
    font-size: 18px;
    cursor: pointer;
}

/* Chat Messages */
#bot-messages {
    padding: 10px;
    height: 220px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
}

/* Bot & User Messages */
.bot-text, .user-text {
    padding: 8px 12px;
    border-radius: 15px;
    max-width: 75%;
    margin-bottom: 8px;
    animation: fadeIn 0.3s ease-in-out;
}

.bot-text {
    background: #f1f1f1;
    align-self: flex-start;
}

.user-text {
    background: #0084FF;
    color: white;
    align-self: flex-end;
}

/* Typing Indicator */
.typing {
    background: #f1f1f1;
    font-style: italic;
}

/* Input Field */
#bot-input {
    display: flex;
    padding: 10px;
    background: #f9f9f9;
}

#user-message {
    flex-grow: 1;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 14px;
}

#send-message {
    background: #4A90E2;
    color: white;
    border: none;
    padding: 8px;
    cursor: pointer;
    margin-left: 5px;
    border-radius: 5px;
    font-size: 16px;
}

/* Hide Chat Initially */
.hidden {
    display: none;
}

/* Floating Animation */
@keyframes floaty {
    from {
        transform: translateY(0);
    }
    to {
        transform: translateY(-3.5px);
    }
}

/* Fade-In Effect */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Floating Bot */
#floating-bot {
    position: fixed;
    bottom: 10px;
    right: 50px;
    margin: 10px;
    border-radius: 50%;
   display: flex;

   justify-content: center;
    z-index: 1000;
    /* opacity: 0.5; */
 
}
dotlottie-player{
    max-width:300px;
    /* border: 50%; */
    /* opacity: 1; */
}

/* Bot Icon */
#bot-icon {
    width: 40px;
    max-height: 60px;
    background: linear-gradient(135deg, #4A90E2, #0084FF);
    color: white;
    border-radius: 50%;
    font-size: 30px;
    /* opacity: 1; */
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 10px;
    position: fixed;
    bottom: 0px;
    right: 0px;
    position: fixed;
    cursor: pointer;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    transition: transform 0.3s ease-in-out, bottom 0.5s ease-in-out;
}

#bot-icon:hover {
    transform: scale(1.1);
}

/* Chat Box */
#bot-chat {
    height: 70%;
    width: 700px;
    background: white;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    overflow: hidden;
    position: fixed;
    bottom: 110px;
    right: 165px;
    display: none;
    flex-direction: column;
    font-family: Arial, sans-serif;
    opacity: 0;
    transform: translateY(20px);
    transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
}


/* Show Class for Animation */
#bot-chat.show {
    display: flex;
    opacity: 1;
    transform: translateY(0);
}

/* Chat Header */
#bot-header {
    background: #4A90E2;
    color: white;
    padding: 10px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 16px;
    font-weight: bold;
}

#close-bot {
    background: none;
    border: none;
    color: white;
    font-size: 18px;
    cursor: pointer;
}

/* Chat Messages */
#bot-messages {
    padding: 10px;
    height: 400px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
}

.bot-text {
    background: #f1f1f1;
    padding: 8px 12px;
    border-radius: 15px;
    max-width: 75%;
    margin-bottom: 8px;
}

.user-text {
    background: #0084FF;
    color: white;
    align-self: flex-end;
}

/* Input Field */
#bot-input {
    display: flex;
    padding: 10px;
    background: #f9f9f9;
}

#user-message {
    flex-grow: 1;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 14px;
}

#send-message {
    background: #4A90E2;
    color: white;
    border: none;
    padding: 8px;
    cursor: pointer;
    margin-left: 5px;
    border-radius: 5px;
    font-size: 16px;
}

/* Hide Chat Initially */
.hidden {
    display: none;
}


/* Bot Icon with Lottie Animation */
#bot-icon {
    width: 70px;
    height: 100px;
    border-radius: 50%;
    position: relative; /* Ensures layering */
    cursor: pointer;
    box-shadow: 0 8px 20px rgb(0, 174, 255);
    transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
    animation: floaty 3s ease-in-out infinite alternate;
    background: transparent; /* Removes background */
    display: flex;
    align-items: center;
    justify-content: center;
}



/* Clickable overlay to fix Lottie blocking clicks */
#bot-icon::after {
    content: "";
    position: absolute;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    border-radius: 50%;
    background: transparent;
    z-index: 2; /* Ensures clicks go through */
}

/* Ensure Lottie animation fits well */
#bot-icon dotlottie-player {
    width: 100%;
    height: 100%;
    position: absolute;
    z-index: 1; /* Keeps Lottie behind the overlay */
}


.bot-text{
    color: black;
    text-align: start;
}


    </style>
    <!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://lottie.host/2ff7cd10-1494-4861-840a-89b7b2197564/VPVjGQtPNT.lottie">

</head>
<body>
    <div class="header">
        <div class="logo">Emergency Aid Now</div>
        <div class="nav">
            <a href="/">Home</a>
            <a href="/reqHelp">Request Help</a>
            <a href="/offHelp">Offer Help</a>
            <a href="/dashboard">Dashboard</a>
            <a href="/api/risk/predict-risk">Risk Zones</a>
            <a href="/location">Get Report</a>


            <!-- <button class="login-btn">Login</button> -->
        </div>
    </div>

    <div class="content">
        <h1 class="title">Emergency Aid Now</h1>
        <p class="description">
            Connecting people in need with those who can help during emergencies and natural disasters.
            Request assistance or offer your support to those affected.
        </p>
        <div class="buttons">
            <a href="reqhelp"><button class="btn">Request Help</button></a>
           <a href="offhelp"> <button class="btn">Offer Help</button></a>
        </div>

        <div class="map-section">
            <h2>Real-time Disaster Map</h2>
          
                <div class="map-placeholder" id="disasterMap" style="height: 400px; width: 100%; border-radius: 8px;"></div>

           
            <button class="view-map-btn">View Full Map</button>
            <div class="legend">
                <span><span style="display: inline-block; width: 12px; height: 12px; background-color: #d32f2f; border-radius: 50%;"></span> High Severity</span>
                <span><span style="display: inline-block; width: 12px; height: 12px; background-color: #ffca28; border-radius: 50%;"></span> Medium Severity</span>
                <span><span style="display: inline-block; width: 12px; height: 12px; background-color: #0288d1; border-radius: 50%;"></span> Low Severity</span>
            </div>
        </div>

        <div class="status-section">
            <h2>Current Status</h2>
            <div class="status-grid">
                <div class="status-card">
                    <p>Active Help Requests</p>
                    <h3><%= requests %></h3>

                    <!-- <p>‚Üë 12% vs last week</p> -->
                </div>
                <div class="status-card">
                    <p>Available Volunteers</p>
                    <h3><%= volunteers %></h3>
                    <!-- <h3>56</h3> -->
                    <!-- <p>‚Üë 5% vs last week</p> -->
                </div>
                <div class="status-card">
                    <p>Successful Aid Deliveries</p>
                    <h3><%= deliveries %></h3>
                    <!-- <p>‚Üë 1% vs last week</p> -->
                </div>




               
            </div>
        </div>

        <div class="how-it-works">
            <h2>How It Works</h2>
            <p class="description">
                Our platform connects those in need with volunteers and organizations that can provide assistance during
                emergencies and natural disasters.
            </p>
            <div class="how-it-works-items">
                <div class="how-it-works-item">
                    <i class="fas fa-exclamation-triangle" style="color: #d32f2f;"></i>
                    <h3>Request Help</h3>
                    <p>If you're affected by a disaster, submit a request detailing your location and needs.</p>
                </div>
                <div class="how-it-works-item">
                    <i class="fas fa-user" style="color: #1a2a44;"></i>
                    <h3>Volunteer</h3>
                    <p>Register as a volunteer to offer your services, resources, or expertise to those in need.</p>
                </div>
                <div class="how-it-works-item">
                    <i class="fas fa-check" style="color: #0288d1;"></i>
                    <h3>Get Matched</h3>
                    <p>Our system matches help requests with nearby volunteers who can provide the needed assistance.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <div class="footer-section">
            <h3>Emergency Aid Now</h3>
            <p>Connecting those in need with those who can help during emergencies and natural disasters.</p>
        </div>
        <div class="footer-section">
            <h3>Quick Links</h3>
            <a href="/">Home</a>
            <a href="reqhelo">Request Help</a>
            <a href="offhelp">Offer Help</a>
            <a href="/dashbord">Admin Dashboard</a>
        </div>
        <div class="footer-section">
            <h3>Resources</h3>
            <a href="#">Emergency Contacts</a>
            <a href="#">Safety Tips</a>
            <a href="#">About Us</a>
            <a href="#">Privacy Policy</a>
        </div>
        <div class="footer-section">
            <h3>Contact</h3>
            <p><i class="fas fa-envelope"></i> contact@emergencyaidnow.org</p>
            <p><i class="fas fa-phone"></i> +1 (234) 567-890</p>
        </div>
        <div class="footer-bottom">
            <p>¬© 2025 Emergency Aid Now. All rights reserved.</p>
            <p>Made with <i class="fas fa-heart" style="color: #d32f2f;"></i> for those in need</p>
        </div>
    </div>
    
    <div id="floating-bot">
      <div id="bot-icon">
          <script src="https://unpkg.com/@dotlottie/player-component@2.7.12/dist/dotlottie-player.mjs"
              type="module"></script>

          <dotlottie-player src="https://lottie.host/2ff7cd10-1494-4861-840a-89b7b2197564/VPVjGQtPNT.lottie"
              background="transparent" speed="1" style="width: 300px; height: 300px" loop autoplay>

          </dotlottie-player>
      </div>

      <div id="bot-chat" class="hidden">
          <div id="bot-header">
              <span>AI Bot</span>
              <button id="close-bot">&times;</button>
          </div>
          <div id="bot-messages">
              <p class="bot-text">Hello! How can I help you?</p>
          </div>
          <div id="bot-input">
              <input type="text" id="user-message" placeholder="Ask me anything...">
              <button id="send-message">‚û§</button>
          </div>
      </div>

<!-- Leaflet JS -->
<script>
    const mapContainer = document.getElementById('disasterMap');
    const viewBtn = document.querySelector('.view-map-btn');
  
    let isFullscreen = false;
  
    viewBtn.addEventListener('click', () => {
      isFullscreen = !isFullscreen;
  
      if (isFullscreen) {
        mapContainer.classList.add('fullscreen');
        document.body.classList.add('fullscreen-map');
        viewBtn.innerText = "Exit Full Map";
      } else {
        mapContainer.classList.remove('fullscreen');
        document.body.classList.remove('fullscreen-map');
        viewBtn.innerText = "View Full Map";
      }
  
      // Important: delay resize so Leaflet can adjust to new container size
      setTimeout(() => {
        map.invalidateSize();
      }, 350);
    });
  </script>
  <script>
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape' && isFullscreen) {
        mapContainer.classList.remove('fullscreen');
        document.body.classList.remove('fullscreen-map');
        viewBtn.innerText = "View Full Map";
        isFullscreen = false;
        setTimeout(() => map.invalidateSize(), 300);
      }
    });
  </script>
  
  
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  const map = L.map('disasterMap').setView([20.5937, 78.9629], 5); // Center on India

  // Add OpenStreetMap tiles
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap contributors'
  }).addTo(map);

  // Severity to color mapping
  const severityColors = {
    High: '#d32f2f',
    Medium: '#ffca28',
    Low: '#0288d1'
  };

  // Fetch disaster data from the API
  fetch('/api/disasters/grouped')
    .then(res => res.json())
    .then(data => {
      for (const severity in data) {
        const color = getColor(severity); // Get color based on severity
        data[severity].forEach(disaster => {
          if (disaster.location && disaster.location.lat && disaster.location.lng) {
            plotMarker(disaster.location.lat, disaster.location.lng, color, disaster.city, severity);
          }
        });
      }
    })
    .catch(err => {
      console.error("Failed to fetch disaster data:", err);
    });

  // Function to plot marker on map
  function plotMarker(lat, lng, color, city, severity) {
    L.circleMarker([lat, lng], {
      radius: 8,
      color: color,
      fillColor: color,
      fillOpacity: 0.9
    }).addTo(map).bindPopup(`<strong>${city}</strong><br>Severity: ${severity}`);
  }

  // Utility to get color based on severity
  function getColor(severity) {
    if (severity === 'High') return '#d32f2f';
    if (severity === 'Medium') return '#ffca28';
    return '#0288d1'; // Default = Low
  }
</script>
<script>
    // Embedded JS
    document.addEventListener("DOMContentLoaded", () => {
    // üü¢ Ensure Chatbox Opens and Closes Properly
    const botIcon = document.getElementById("bot-icon");
    const botChat = document.getElementById("bot-chat");
    const closeBot = document.getElementById("close-bot");
    const sendMessage = document.getElementById("send-message");
    const userMessageInput = document.getElementById("user-message-input");
    const botMessages = document.getElementById("bot-messages");

    // üü¢ Open/Close Chatbox
    botIcon.addEventListener("click", () => {
        botChat.classList.toggle("show");
    });

    closeBot.addEventListener("click", () => {
        botChat.classList.remove("show");
    });

    // üü¢ Close on Click Outside
    document.addEventListener("click", (event) => {
        if (!botChat.contains(event.target) && event.target !== botIcon) {
            botChat.classList.remove("show");
        }
    });

    // üü¢ Handle Sending Messages
    sendMessage.addEventListener("click", sendUserMessage);
    userMessageInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
            e.preventDefault();
            sendUserMessage();
        }
    });

    async function sendUserMessage() {
        const userMessage = userMessageInput.value.trim();
        if (!userMessage.replace(/\s/g, "").length) return;

        appendMessage(userMessage, ["user-text"]);
        userMessageInput.value = "";

        const typingIndicator = appendMessage("Thinking...", ["bot-text", "typing"]);

        try {
            const botResponse = await getAIResponse(userMessage);

            typingIndicator.remove();
            appendMessage(botResponse, ["bot-text"]);
        } catch (error) {
            console.error("‚ùå Error:", error);
            typingIndicator.remove();
            appendMessage("Something went wrong, please try again.", ["bot-text", "error-text"]);
        }
    }

    function appendMessage(message, classNames = []) {
        const messageElement = document.createElement("p");
        messageElement.textContent = message;
        classNames.forEach(className => messageElement.classList.add(className));
        botMessages.appendChild(messageElement);
        botMessages.scrollTop = botMessages.scrollHeight;
        return messageElement;
    }

    async function getAIResponse(userMessage) {
        try {
            console.log("Sending request:", { userMessage });

            const response = await fetch("/api/chat", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ userMessage })  // No need for userSession
            });

            if (!response.ok) throw new Error(`HTTP Error! Status: ${response.status}`);

            const data = await response.json();
            console.log("üü¢ AI Response:", data);

            return data.response || "I'm not sure, could you clarify? ü§î";
        } catch (error) {
            console.error("‚ùå Failed to fetch AI response:", error);
            return "Something went wrong, please try again.";
        }
    }
});

      app.post('/api/chat', async (req, res) => {
    try {
        const { userMessage } = req.body; // Accept user message
        if (!userMessage) {
            return res.status(400).json({ error: "Message is required" });
        }

        // Initialize message stack for "guest" or user identification can be managed if needed
        const userId = 'guest';  // or any dynamic user identifier
        
        if (!messageStack[userId]) {
            messageStack[userId] = [];
        }

        // Store user messages
        messageStack[userId].push(userMessage);

        // Limit stack size to avoid memory overload
        if (messageStack[userId].length > 5) {
            messageStack[userId].shift(); // Remove the oldest message
        }

        const conversationHistory = messageStack[userId]
            .map((msg, index) => `#${index + 1}: ${msg}`)
            .join("\n");

        const aiPrompt = `
üÜò **Disaster Relief Helper Bot**

üßë‚Äçüíº **User ID**: ${userId}
üí¨ **Recent Queries**:
${conversationHistory}

üìå **Instructions**:
- Answer like a trained disaster response assistant.
- Help users find resources: food, shelter, medicine, volunteer help.
- Ask location or emergency type if needed.
- Use calm, clear, helpful language.
- Respond as if helping during an actual disaster.

ü§ñ **Response**:
`;

        // Get response from the AI service
        const botResponse = await getAIResponse(aiPrompt);

        // Send back the AI response
        res.json({ response: botResponse });

    } catch (error) {
        console.error("‚ùå Chat Route Error:", error.message);
        res.status(500).json({ error: "Internal server error" });
    }
});

  </script>


</body>
</html>